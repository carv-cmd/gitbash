# GitHub over OpenSSH

### *Verify you have open-ssh installed.*
```bash
# Check upstream cache
apt-cache show ssh

# If `ssh` doesn't exist on your host install it.
if ! command -v ssh; then
    sudo apt-get install ssh
fi
```

## SSH Key Generation
**Generate an *id_ed25519* ssh-key-pair.**

<details><summary>GENERATE MANUALLY</summary>
<p>
    
***Please run `man ssh-keygen`, this is just an outline.***

**Create key --type:id_ed25519 with your_github_email for its --comment**

```bash
$ ssh-keygen -t id_ed25591 -C 'GITHUB_EMAIL@EMAIL.com'
> <use defaults>
```

**Two files should have been created in *~/.ssh/***
* *id_ed22519* - PRIVATE KEY. Keep this secure.
    ```bash
    $ cat ~/.ssh/config/id_ed25519
    --BEGIN OPENSSH PRIVATE KEY--
        LONG-RANDOM-STRING
    ---END OPENSSH PRIVATE KEY---
    ```
* *id_ed25519.pub* - PUBLIC KEY. Upload this to GitHub.
    ```bash
    $ cat ~/.ssh/config/id_ed25519.pub
    ssh-ed25519 <SHA-STRING> GITHUB_EMAIL@EMAIL.com 
    ```
---

</p>
</details>
    
Or run [**`gitman users --keygen`**](bin/users.sh) which prints the public key to upload.
        
**Either way you will be prompted for a few questions, notably the one asking for a *passphrase*.**
* If you set a *passphrase* you will be prompted for it every time you push/pull upstream.
* For that reason the *passphrase* may be left empty if security is not a concern.

## ~/.ssh/config

Please read the [*OpenSSH Documentation*](https://www.openssh.com/) if you plan to use it extensively.
A properly configured client and server are the first line of defense.
Configuration is dependant on the use case and the template provided here is just that.

<details><summary>Configuration Help</summary>
<p>

*SSH Manual Pages*
```bash
man ssh

# SSH Client config (outgoing)
man ssh_config

# SSH Server config (incoming)
man sshd_config
```

*From system "/etc/ssh/ssh_config" file.*
```txt
Any configuration value is only changed the first time it is set.
Thus, host-specific definitions should be at the beginning of the
configuration file, and defaults at the end. 
```
---

</p>
</details>

**The `~/.ssh/config` file *will not* be generated by default.**
* You will need to create it with `touch ~/.ssh/config`.
* If ~/.ssh/config does exist just insert the `Host gh` record.

**Setting `ControlMaster`, `ControlPath`, `ControlPersist` will reuse the SSH connection.**
* If you have slower internet or work alot with upstreams this may help speed up workflows.

***Template: ~/.ssh/config***
```txt
# Test w/ `ssh -T gh`
Host gh
    Hostname github.com
    User git
    IdentityFile ~/.ssh/id_ed25519
    VisualHostKey no
    # Multiplex, persist( 1h ).
    # ControlMaster auto
    # ControlPath ~/.ssh/master-%r@%h:%p.socket
    # ControlPersist 1h

Host *
    ForwardAgent no
    ForwardX11 no
    ForwardX11Trusted yes
    Port 22
    Protocol 2
    VisualHostKey yes
    PreferredAuthentications publickey
    PasswordAuthentication yes
    LogLevel INFO
```

## Configure the GH-CLI to use SSH
You will need to modify "~/.config/gh/config.yml".
* This can be done with your favorite text editor or the `sed` command below.
```bash
# Locate Record -> git_protocol: [ if 'https' replace with 'ssh' ]
(vim||nano) ~/.config/gh/config.yml

# Dryrun without [-i] first. Modifies inplace.
if cat ~/.config/gh/config.yml; then
    sed [-i] 's/^git_protocol: https/git_protocol: ssh/' ~/.config/gh/config.yml
fi
```

## Existing Remotes
Remote URL formats:
* `https://github.com/GIT_USER/GIT_REPO.git`
* `git@github.com:USERNAME/REPOSITORY.git`

If you cloned a repository with *HTTPS* change its remote to *SSH* with the following.
```bash
# You must be in a git repo to check its remotes
cd ~/local-git-repo

# Check remote URL's known to ~/local-git-repo
if git remote -v; then
    
    # Change remote URL's like so
    git remote set-url origin git@github.com:USERNAME/REPOSITORY.git
    
    # Check new remote URL's    
    git remote -v
fi
```

## SSH-Agent
If you created "~/.ssh/config" this shouldnt be needed.
* If you're having problems though try:
```bash
# Start ssh-agent in background
ssh-agent -s
eval "$(ssh-agent -s)"

# Add private key to ssh-agent, (prompts for passphrase if key has one)
ssh-add ~/.ssh/id_ed25591

# Test
ssh -T ssh
```
